<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Delta Chat Core C-Library: /home/bpetersen/projects/deltachat-core/src/mrmailbox_configure.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="user.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Delta Chat Core C-Library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">mrmailbox_configure.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*******************************************************************************</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *                              Delta Chat Core</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *                      Copyright (C) 2017 Bj√∂rn Petersen</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *                   Contact: r10s@b44t.com, http://b44t.com</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * This program is free software: you can redistribute it and/or modify it under</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * the terms of the GNU General Public License as published by the Free Software</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * Foundation, either version 3 of the License, or (at your option) any later</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> * version.</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> * This program is distributed in the hope that it will be useful, but WITHOUT</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> * FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * details.</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> * You should have received a copy of the GNU General Public License along with</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> * this program.  If not, see http://www.gnu.org/licenses/ .</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> ******************************************************************************/</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &lt;dirent.h&gt;</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;mrmailbox_internal.h&quot;</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &quot;mrloginparam.h&quot;</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &quot;mrimap.h&quot;</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &quot;mrsmtp.h&quot;</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &quot;mrosnative.h&quot;</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &quot;mrsaxparser.h&quot;</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &quot;mrjob.h&quot;</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">/*******************************************************************************</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment"> * Tools</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment"> ******************************************************************************/</span></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span>* read_autoconf_file(<a class="code" href="structmrmailbox__t.html">mrmailbox_t</a>* mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span>* url)</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;{</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    <span class="keywordtype">char</span>* filecontent = NULL;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    mrmailbox_log_info(mailbox, 0, <span class="stringliteral">&quot;Testing %s ...&quot;</span>, url);</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    filecontent = (<span class="keywordtype">char</span>*)mailbox-&gt;m_cb(mailbox, MR_EVENT_HTTP_GET, (uintptr_t)url, 0);</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    <span class="keywordflow">if</span>( filecontent == NULL ) {</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;        mrmailbox_log_info(mailbox, 0, <span class="stringliteral">&quot;Can&#39;t read file.&quot;</span>); <span class="comment">/* this is not a warning or an error, we&#39;re just testing */</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;        <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    }</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="keywordflow">return</span> filecontent;</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;}</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="comment">/*******************************************************************************</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment"> * Thunderbird&#39;s Autoconfigure</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment"> ******************************************************************************/</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>moz_autoconfigure_t</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;{</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="keyword">const</span> mrloginparam_t* m_in;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="keywordtype">char</span>*                 m_in_emaildomain;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <span class="keywordtype">char</span>*                 m_in_emaillocalpart;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    mrloginparam_t*       m_out;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="keywordtype">int</span>                   m_out_imap_set, m_out_smtp_set;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="comment">/* currently, we assume there is only one emailProvider tag in the</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="comment">    file, see example at https://wiki.mozilla.org/Thunderbird:Autoconfiguration:ConfigFileFormat</span></div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment">    moreover, we assume, the returned domains match the one queried.  I&#39;ve not seen another example (bp).</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment">    However, _if_ the assumpltions are wrong, we can add a first saxparser-pass that searches for the correct domain</span></div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment">    and the second pass will look for the index found. */</span></div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="preprocessor">    #define MOZ_SERVER_IMAP 1</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="preprocessor">    #define MOZ_SERVER_SMTP 2</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keywordtype">int</span> m_tag_server;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="preprocessor">    #define MOZ_HOSTNAME   10</span></div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="preprocessor">    #define MOZ_PORT       11</span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="preprocessor">    #define MOZ_USERNAME   12</span></div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="preprocessor">    #define MOZ_SOCKETTYPE 13</span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="keywordtype">int</span> m_tag_config;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;} moz_autoconfigure_t;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> moz_autoconfigure_starttag_cb(<span class="keywordtype">void</span>* userdata, <span class="keyword">const</span> <span class="keywordtype">char</span>* tag, <span class="keywordtype">char</span>** attr)</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;{</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    moz_autoconfigure_t* moz_ac = (moz_autoconfigure_t*)userdata;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span>*          p1;</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="keywordflow">if</span>( strcmp(tag, <span class="stringliteral">&quot;incomingserver&quot;</span>)==0 ) {</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        moz_ac-&gt;m_tag_server = (moz_ac-&gt;m_out_imap_set==0 &amp;&amp; (p1=mrattr_find(attr, <span class="stringliteral">&quot;type&quot;</span>))!=NULL &amp;&amp; strcasecmp(p1, <span class="stringliteral">&quot;imap&quot;</span>)==0)? MOZ_SERVER_IMAP : 0;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        moz_ac-&gt;m_tag_config = 0;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    }</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(tag, <span class="stringliteral">&quot;outgoingserver&quot;</span>) == 0 ) {</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        moz_ac-&gt;m_tag_server = moz_ac-&gt;m_out_smtp_set==0? MOZ_SERVER_SMTP : 0;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        moz_ac-&gt;m_tag_config = 0;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    }</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(tag, <span class="stringliteral">&quot;hostname&quot;</span>) == 0   ) { moz_ac-&gt;m_tag_config = MOZ_HOSTNAME; }</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(tag, <span class="stringliteral">&quot;port&quot;</span>) == 0       ) { moz_ac-&gt;m_tag_config = MOZ_PORT; }</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(tag, <span class="stringliteral">&quot;sockettype&quot;</span>) == 0 ) { moz_ac-&gt;m_tag_config = MOZ_SOCKETTYPE; }</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(tag, <span class="stringliteral">&quot;username&quot;</span>) == 0   ) { moz_ac-&gt;m_tag_config = MOZ_USERNAME; }</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;}</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> moz_autoconfigure_text_cb(<span class="keywordtype">void</span>* userdata, <span class="keyword">const</span> <span class="keywordtype">char</span>* text, <span class="keywordtype">int</span> len)</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;{</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    moz_autoconfigure_t*   moz_ac = (moz_autoconfigure_t*)userdata;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    <span class="keywordtype">char</span>* val = safe_strdup(text);</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    mr_trim(val);</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    mr_str_replace(&amp;val, <span class="stringliteral">&quot;%EMAILADDRESS%&quot;</span>,   moz_ac-&gt;m_in-&gt;m_addr);</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    mr_str_replace(&amp;val, <span class="stringliteral">&quot;%EMAILLOCALPART%&quot;</span>, moz_ac-&gt;m_in_emaillocalpart);</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    mr_str_replace(&amp;val, <span class="stringliteral">&quot;%EMAILDOMAIN%&quot;</span>,    moz_ac-&gt;m_in_emaildomain);</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    <span class="keywordflow">if</span>( moz_ac-&gt;m_tag_server == MOZ_SERVER_IMAP ) {</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        <span class="keywordflow">switch</span>( moz_ac-&gt;m_tag_config ) {</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;            <span class="keywordflow">case</span> MOZ_HOSTNAME: free(moz_ac-&gt;m_out-&gt;m_mail_server); moz_ac-&gt;m_out-&gt;m_mail_server = val; val = NULL; <span class="keywordflow">break</span>;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;            <span class="keywordflow">case</span> MOZ_PORT:                                         moz_ac-&gt;m_out-&gt;m_mail_port   = atoi(val);       <span class="keywordflow">break</span>;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;            <span class="keywordflow">case</span> MOZ_USERNAME: free(moz_ac-&gt;m_out-&gt;m_mail_user);   moz_ac-&gt;m_out-&gt;m_mail_user   = val; val = NULL; <span class="keywordflow">break</span>;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;            <span class="keywordflow">case</span> MOZ_SOCKETTYPE:</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;                <span class="keywordflow">if</span>( strcasecmp(val, <span class="stringliteral">&quot;ssl&quot;</span>)==0 )      { moz_ac-&gt;m_out-&gt;m_server_flags |=MR_IMAP_SOCKET_SSL; }</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                <span class="keywordflow">if</span>( strcasecmp(val, <span class="stringliteral">&quot;starttls&quot;</span>)==0 ) { moz_ac-&gt;m_out-&gt;m_server_flags |=MR_IMAP_SOCKET_STARTTLS; }</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                <span class="keywordflow">if</span>( strcasecmp(val, <span class="stringliteral">&quot;plain&quot;</span>)==0 )    { moz_ac-&gt;m_out-&gt;m_server_flags |=MR_IMAP_SOCKET_PLAIN; }</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        }</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    }</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( moz_ac-&gt;m_tag_server == MOZ_SERVER_SMTP ) {</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        <span class="keywordflow">switch</span>( moz_ac-&gt;m_tag_config ) {</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;            <span class="keywordflow">case</span> MOZ_HOSTNAME: free(moz_ac-&gt;m_out-&gt;m_send_server); moz_ac-&gt;m_out-&gt;m_send_server = val; val = NULL; <span class="keywordflow">break</span>;</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;            <span class="keywordflow">case</span> MOZ_PORT:                                         moz_ac-&gt;m_out-&gt;m_send_port   = atoi(val);       <span class="keywordflow">break</span>;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;            <span class="keywordflow">case</span> MOZ_USERNAME: free(moz_ac-&gt;m_out-&gt;m_send_user);   moz_ac-&gt;m_out-&gt;m_send_user   = val; val = NULL; <span class="keywordflow">break</span>;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;            <span class="keywordflow">case</span> MOZ_SOCKETTYPE:</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                <span class="keywordflow">if</span>( strcasecmp(val, <span class="stringliteral">&quot;ssl&quot;</span>)==0 )      { moz_ac-&gt;m_out-&gt;m_server_flags |=MR_SMTP_SOCKET_SSL; }</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                <span class="keywordflow">if</span>( strcasecmp(val, <span class="stringliteral">&quot;starttls&quot;</span>)==0 ) { moz_ac-&gt;m_out-&gt;m_server_flags |=MR_SMTP_SOCKET_STARTTLS; }</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                <span class="keywordflow">if</span>( strcasecmp(val, <span class="stringliteral">&quot;plain&quot;</span>)==0 )    { moz_ac-&gt;m_out-&gt;m_server_flags |=MR_SMTP_SOCKET_PLAIN; }</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        }</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    }</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    free(val);</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;}</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> moz_autoconfigure_endtag_cb(<span class="keywordtype">void</span>* userdata, <span class="keyword">const</span> <span class="keywordtype">char</span>* tag)</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;{</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    moz_autoconfigure_t* moz_ac = (moz_autoconfigure_t*)userdata;</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="keywordflow">if</span>( strcmp(tag, <span class="stringliteral">&quot;incomingserver&quot;</span>)==0 ) {</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        moz_ac-&gt;m_tag_server = 0;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        moz_ac-&gt;m_tag_config = 0;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        moz_ac-&gt;m_out_imap_set = 1;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    }</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(tag, <span class="stringliteral">&quot;outgoingserver&quot;</span>)==0 ) {</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        moz_ac-&gt;m_tag_server = 0;</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        moz_ac-&gt;m_tag_config = 0;</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        moz_ac-&gt;m_out_smtp_set = 1;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    }</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <span class="keywordflow">else</span> {</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        moz_ac-&gt;m_tag_config = 0;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    }</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;}</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="keyword">static</span> mrloginparam_t* moz_autoconfigure(<a class="code" href="structmrmailbox__t.html">mrmailbox_t</a>* mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span>* url, <span class="keyword">const</span> mrloginparam_t* param_in)</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;{</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    <span class="keywordtype">char</span>*               xml_raw = NULL;</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    moz_autoconfigure_t moz_ac;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    memset(&amp;moz_ac, 0, <span class="keyword">sizeof</span>(moz_autoconfigure_t));</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="keywordflow">if</span>( (xml_raw=read_autoconf_file(mailbox, url))==NULL ) {</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        <span class="keywordflow">goto</span> cleanup;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    }</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    moz_ac.m_in                = param_in;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    moz_ac.m_in_emaillocalpart = safe_strdup(param_in-&gt;m_addr); <span class="keywordtype">char</span>* p = strchr(moz_ac.m_in_emaillocalpart, <span class="charliteral">&#39;@&#39;</span>); <span class="keywordflow">if</span>( p == NULL ) { <span class="keywordflow">goto</span> cleanup; } *p = 0;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    moz_ac.m_in_emaildomain    = safe_strdup(p+1);</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    moz_ac.m_out               = mrloginparam_new();</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    mrsaxparser_t                 saxparser;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    mrsaxparser_init            (&amp;saxparser, &amp;moz_ac);</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    mrsaxparser_set_tag_handler (&amp;saxparser, moz_autoconfigure_starttag_cb, moz_autoconfigure_endtag_cb);</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    mrsaxparser_set_text_handler(&amp;saxparser, moz_autoconfigure_text_cb);</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    mrsaxparser_parse           (&amp;saxparser, xml_raw);</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    <span class="keywordflow">if</span>( moz_ac.m_out-&gt;m_mail_server == NULL</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;     || moz_ac.m_out-&gt;m_mail_port   == 0</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;     || moz_ac.m_out-&gt;m_send_server == NULL</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;     || moz_ac.m_out-&gt;m_send_port   == 0 )</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    {</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        { <span class="keywordtype">char</span>* r = mrloginparam_get_readable(moz_ac.m_out); mrmailbox_log_warning(mailbox, 0, <span class="stringliteral">&quot;Bad or incomplete autoconfig: %s&quot;</span>, r); free(r); }</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        mrloginparam_unref(moz_ac.m_out); <span class="comment">/* autoconfig failed for the given URL */</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        moz_ac.m_out = NULL;</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        <span class="keywordflow">goto</span> cleanup;</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    }</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;cleanup:</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    free(xml_raw);</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    free(moz_ac.m_in_emaildomain);</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    free(moz_ac.m_in_emaillocalpart);</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="keywordflow">return</span> moz_ac.m_out; <span class="comment">/* may be NULL */</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;}</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="comment">/*******************************************************************************</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="comment"> * Outlook&#39;s Autodiscover</span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="comment"> ******************************************************************************/</span></div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>outlk_autodiscover_t</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;{</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <span class="keyword">const</span> mrloginparam_t* m_in;</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    mrloginparam_t*       m_out;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="keywordtype">int</span>                   m_out_imap_set, m_out_smtp_set;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="comment">/* file format: https://msdn.microsoft.com/en-us/library/bb204278(v=exchg.80).aspx */</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="preprocessor">    #define  OUTLK_TYPE         1</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="preprocessor">    #define  OUTLK_SERVER       2</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="preprocessor">    #define  OUTLK_PORT         3</span></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="preprocessor">    #define  OUTLK_SSL          4</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="preprocessor">    #define  OUTLK_REDIRECTURL  5</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="preprocessor">    #define _OUTLK_COUNT_       6</span></div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="keywordtype">int</span>      m_tag_config;</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <span class="keywordtype">char</span>*    m_config[_OUTLK_COUNT_];</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordtype">char</span>*    m_redirect;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;} outlk_autodiscover_t;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> outlk_clean_config(outlk_autodiscover_t* outlk_ad)</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;{</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    <span class="keywordtype">int</span> i;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; _OUTLK_COUNT_; i++ ) {</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        free(outlk_ad-&gt;m_config[i]);</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        outlk_ad-&gt;m_config[i] = NULL;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    }</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;}</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> outlk_autodiscover_starttag_cb(<span class="keywordtype">void</span>* userdata, <span class="keyword">const</span> <span class="keywordtype">char</span>* tag, <span class="keywordtype">char</span>** attr)</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;{</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    outlk_autodiscover_t* outlk_ad = (outlk_autodiscover_t*)userdata;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;         <span class="keywordflow">if</span>( strcmp(tag, <span class="stringliteral">&quot;protocol&quot;</span>) == 0    ) { outlk_clean_config(outlk_ad); } <span class="comment">/* this also cleans &quot;redirecturl&quot;, however, this is not problem as the protocol block is only valid for action &quot;settings&quot;. */</span></div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(tag, <span class="stringliteral">&quot;type&quot;</span>) == 0        ) { outlk_ad-&gt;m_tag_config = OUTLK_TYPE; }</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(tag, <span class="stringliteral">&quot;server&quot;</span>) == 0      ) { outlk_ad-&gt;m_tag_config = OUTLK_SERVER; }</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(tag, <span class="stringliteral">&quot;port&quot;</span>) == 0        ) { outlk_ad-&gt;m_tag_config = OUTLK_PORT; }</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(tag, <span class="stringliteral">&quot;ssl&quot;</span>) == 0         ) { outlk_ad-&gt;m_tag_config = OUTLK_SSL; }</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(tag, <span class="stringliteral">&quot;redirecturl&quot;</span>) == 0 ) { outlk_ad-&gt;m_tag_config = OUTLK_REDIRECTURL; }</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;}</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> outlk_autodiscover_text_cb(<span class="keywordtype">void</span>* userdata, <span class="keyword">const</span> <span class="keywordtype">char</span>* text, <span class="keywordtype">int</span> len)</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;{</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    outlk_autodiscover_t* outlk_ad = (outlk_autodiscover_t*)userdata;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <span class="keywordtype">char</span>* val = safe_strdup(text);</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    mr_trim(val);</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    free(outlk_ad-&gt;m_config[outlk_ad-&gt;m_tag_config]);</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    outlk_ad-&gt;m_config[outlk_ad-&gt;m_tag_config] = val;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;}</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> outlk_autodiscover_endtag_cb(<span class="keywordtype">void</span>* userdata, <span class="keyword">const</span> <span class="keywordtype">char</span>* tag)</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;{</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    outlk_autodiscover_t* outlk_ad = (outlk_autodiscover_t*)userdata;</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <span class="keywordflow">if</span>( strcmp(tag, <span class="stringliteral">&quot;protocol&quot;</span>)==0 )</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    {</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        <span class="comment">/* copy collected confituration to m_out (we have to delay this as we do not know when the &lt;type&gt; tag appears in the sax-stream) */</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        <span class="keywordflow">if</span>( outlk_ad-&gt;m_config[OUTLK_TYPE] )</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        {</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;            <span class="keywordtype">int</span> port    = atoi_null_is_0(outlk_ad-&gt;m_config[OUTLK_PORT]),</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                ssl_on  = (outlk_ad-&gt;m_config[OUTLK_SSL] &amp;&amp; strcasecmp(outlk_ad-&gt;m_config[OUTLK_SSL], <span class="stringliteral">&quot;on&quot;</span> )==0),</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                ssl_off = (outlk_ad-&gt;m_config[OUTLK_SSL] &amp;&amp; strcasecmp(outlk_ad-&gt;m_config[OUTLK_SSL], <span class="stringliteral">&quot;off&quot;</span>)==0);</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;            <span class="keywordflow">if</span>( strcasecmp(outlk_ad-&gt;m_config[OUTLK_TYPE], <span class="stringliteral">&quot;imap&quot;</span>)==0 &amp;&amp; outlk_ad-&gt;m_out_imap_set==0 ) {</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                outlk_ad-&gt;m_out-&gt;m_mail_server = strdup_keep_null(outlk_ad-&gt;m_config[OUTLK_SERVER]);</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                outlk_ad-&gt;m_out-&gt;m_mail_port   = port;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                     <span class="keywordflow">if</span>( ssl_on  ) { outlk_ad-&gt;m_out-&gt;m_server_flags |= MR_IMAP_SOCKET_SSL;   }</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span>( ssl_off ) { outlk_ad-&gt;m_out-&gt;m_server_flags |= MR_IMAP_SOCKET_PLAIN; }</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                outlk_ad-&gt;m_out_imap_set = 1;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;            }</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcasecmp(outlk_ad-&gt;m_config[OUTLK_TYPE], <span class="stringliteral">&quot;smtp&quot;</span>)==0 &amp;&amp; outlk_ad-&gt;m_out_smtp_set==0 ) {</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                outlk_ad-&gt;m_out-&gt;m_send_server = strdup_keep_null(outlk_ad-&gt;m_config[OUTLK_SERVER]);</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                outlk_ad-&gt;m_out-&gt;m_send_port   = port;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                     <span class="keywordflow">if</span>( ssl_on  ) { outlk_ad-&gt;m_out-&gt;m_server_flags |= MR_SMTP_SOCKET_SSL;   }</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span>( ssl_off ) { outlk_ad-&gt;m_out-&gt;m_server_flags |= MR_SMTP_SOCKET_PLAIN; }</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                outlk_ad-&gt;m_out_smtp_set = 1;</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;            }</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        }</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        outlk_clean_config(outlk_ad);</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    }</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    outlk_ad-&gt;m_tag_config = 0;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;}</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="keyword">static</span> mrloginparam_t* outlk_autodiscover(<a class="code" href="structmrmailbox__t.html">mrmailbox_t</a>* mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span>* url__, <span class="keyword">const</span> mrloginparam_t* param_in)</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;{</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    <span class="keywordtype">char</span>*                 xml_raw = NULL, *url = safe_strdup(url__);</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    outlk_autodiscover_t  outlk_ad;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="keywordtype">int</span>                   i;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; 10 <span class="comment">/* follow up to 10 xml-redirects (http-redirects are followed in read_autoconf_file() */</span>; i++ )</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    {</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        memset(&amp;outlk_ad, 0, <span class="keyword">sizeof</span>(outlk_autodiscover_t));</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        <span class="keywordflow">if</span>( (xml_raw=read_autoconf_file(mailbox, url))==NULL ) {</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;            <span class="keywordflow">goto</span> cleanup;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        }</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        outlk_ad.m_in                = param_in;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        outlk_ad.m_out               = mrloginparam_new();</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        mrsaxparser_t                 saxparser;</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        mrsaxparser_init            (&amp;saxparser, &amp;outlk_ad);</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        mrsaxparser_set_tag_handler (&amp;saxparser, outlk_autodiscover_starttag_cb, outlk_autodiscover_endtag_cb);</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        mrsaxparser_set_text_handler(&amp;saxparser, outlk_autodiscover_text_cb);</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        mrsaxparser_parse           (&amp;saxparser, xml_raw);</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        <span class="keywordflow">if</span>( outlk_ad.m_config[OUTLK_REDIRECTURL] &amp;&amp; outlk_ad.m_config[OUTLK_REDIRECTURL][0] ) {</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;            free(url);</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;            url = safe_strdup(outlk_ad.m_config[OUTLK_REDIRECTURL]);</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;            mrloginparam_unref(outlk_ad.m_out);</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;            outlk_clean_config(&amp;outlk_ad);</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;            free(xml_raw); xml_raw = NULL;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        }</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        <span class="keywordflow">else</span> {</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        }</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    }</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <span class="keywordflow">if</span>( outlk_ad.m_out-&gt;m_mail_server == NULL</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;     || outlk_ad.m_out-&gt;m_mail_port   == 0</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;     || outlk_ad.m_out-&gt;m_send_server == NULL</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;     || outlk_ad.m_out-&gt;m_send_port   == 0 )</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    {</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        { <span class="keywordtype">char</span>* r = mrloginparam_get_readable(outlk_ad.m_out); mrmailbox_log_warning(mailbox, 0, <span class="stringliteral">&quot;Bad or incomplete autoconfig: %s&quot;</span>, r); free(r); }</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        mrloginparam_unref(outlk_ad.m_out); <span class="comment">/* autoconfig failed for the given URL */</span></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        outlk_ad.m_out = NULL;</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        <span class="keywordflow">goto</span> cleanup;</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    }</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;cleanup:</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    free(url);</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    free(xml_raw);</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    outlk_clean_config(&amp;outlk_ad);</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="keywordflow">return</span> outlk_ad.m_out; <span class="comment">/* may be NULL */</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;}</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="comment">/*******************************************************************************</span></div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="comment"> * The configuration thread</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="comment"> ******************************************************************************/</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="keyword">static</span> pthread_t s_configure_thread;</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span>       s_configure_thread_created = 0;</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span>       s_configure_do_exit = 1; <span class="comment">/* the value 1 avoids mrmailbox_configure_cancel() from stopping already stopped threads */</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span>* configure_thread_entry_point(<span class="keywordtype">void</span>* entry_arg)</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;{</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <a class="code" href="structmrmailbox__t.html">mrmailbox_t</a>*    mailbox = (<a class="code" href="structmrmailbox__t.html">mrmailbox_t</a>*)entry_arg;</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    mrosnative_setup_thread(mailbox); <span class="comment">/* must be very first */</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="keywordtype">int</span>             success = 0, locked = 0, i;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    <span class="keywordtype">int</span>             imap_connected = 0;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    mrloginparam_t* param = mrloginparam_new();</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    <span class="keywordtype">char</span>*           param_domain = NULL; <span class="comment">/* just a pointer inside param, must not be freed! */</span></div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <span class="keywordtype">char</span>*           param_addr_urlencoded = NULL;</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    mrloginparam_t* param_autoconfig = NULL;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="preprocessor">    #define         PROGRESS(p) \</span></div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="preprocessor">                        if( s_configure_do_exit ) { goto exit_; } \</span></div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;<span class="preprocessor">                        mailbox-&gt;m_cb(mailbox, MR_EVENT_CONFIGURE_PROGRESS, (p), 0);</span></div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    mrmailbox_log_info(mailbox, 0, <span class="stringliteral">&quot;Configure ...&quot;</span>);</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    PROGRESS(0)</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    if( mailbox-&gt;m_cb(mailbox, MR_EVENT_IS_ONLINE, 0, 0)!=1 ) {</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        mrmailbox_log_error(mailbox, MR_ERR_NONETWORK, NULL);</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        <span class="keywordflow">goto</span> exit_;</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    }</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    PROGRESS(10)</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    <span class="comment">/* 1.  Load the parameters and check email-address and password</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="comment">     **************************************************************************/</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    mrsqlite3_lock(mailbox-&gt;m_sql);</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    locked = 1;</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        mrloginparam_read__(param, mailbox-&gt;m_sql, &quot;&quot;);</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    mrsqlite3_unlock(mailbox-&gt;m_sql);</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    locked = 0;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    if( param-&gt;m_addr == NULL ) {</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        mrmailbox_log_error(mailbox, 0, <span class="stringliteral">&quot;Please enter the email address.&quot;</span>);</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        <span class="keywordflow">goto</span> exit_;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    }</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    mr_trim(param-&gt;m_addr);</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    param_domain = strchr(param-&gt;m_addr, <span class="charliteral">&#39;@&#39;</span>);</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <span class="keywordflow">if</span>( param_domain==NULL || param_domain[0]==0 ) {</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        mrmailbox_log_error(mailbox, 0, <span class="stringliteral">&quot;Bad email-address.&quot;</span>);</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        <span class="keywordflow">goto</span> exit_;</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    }</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    param_domain++;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    param_addr_urlencoded = mr_url_encode(param-&gt;m_addr);</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    <span class="comment">/* if no password is given, assume an empty password.</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;<span class="comment">    (in general, unset values are NULL, not the empty string, this allows to use eg. empty user names or empty passwords) */</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    <span class="keywordflow">if</span>( param-&gt;m_mail_pw == NULL ) {</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        param-&gt;m_mail_pw = safe_strdup(NULL);</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    }</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    PROGRESS(20)</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    <span class="comment">/* 2.  Autoconfig</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="comment">     **************************************************************************/</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    if( param-&gt;m_mail_server  == NULL</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;     &amp;&amp; param-&gt;m_mail_port    == 0</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="comment">/*&amp;&amp;param-&gt;m_mail_user    == NULL -- the user can enter a loginname which is used by autoconfig then */</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;     &amp;&amp; param-&gt;m_send_server  == NULL</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;     &amp;&amp; param-&gt;m_send_port    == 0</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;     &amp;&amp; param-&gt;m_send_user    == NULL</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    <span class="comment">/*&amp;&amp;param-&gt;m_send_pw      == NULL -- the password cannot be auto-configured and is no criterion for autoconfig or not */</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;     &amp;&amp; param-&gt;m_server_flags == 0 )</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    {</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        <span class="comment">/* A.  Search configurations from the domain used in the email-address */</span></div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        <span class="keywordflow">for</span>( i = 0; i &lt;= 1; i++ ) {</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;            <span class="keywordflow">if</span>( param_autoconfig==NULL ) {</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                <span class="keywordtype">char</span>* url = mr_mprintf(<span class="stringliteral">&quot;%s://autoconfig.%s/mail/config-v1.1.xml?emailaddress=%s&quot;</span>, i==0?<span class="stringliteral">&quot;http&quot;</span>:<span class="stringliteral">&quot;https&quot;</span>, param_domain, param_addr_urlencoded); <span class="comment">/* Thunderbird may or may not use SSL */</span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                param_autoconfig = moz_autoconfigure(mailbox, url, param);</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                free(url);</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;                PROGRESS(30+i*5)</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;            }</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        }</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        <span class="keywordflow">for</span>( i = 0; i &lt;= 1; i++ ) {</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;            <span class="keywordflow">if</span>( param_autoconfig==NULL ) {</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                <span class="keywordtype">char</span>* url = mr_mprintf(<span class="stringliteral">&quot;https://%s%s/autodiscover/autodiscover.xml&quot;</span>, i==0?<span class="stringliteral">&quot;&quot;</span>:<span class="stringliteral">&quot;autodiscover.&quot;</span>, param_domain); <span class="comment">/* Outlook uses always SSL but different domains */</span></div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                param_autoconfig = outlk_autodiscover(mailbox, url, param);</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                free(url);</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                PROGRESS(40+i*5)</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;            }</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;        }</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;        <span class="comment">/* B.  If we have no configuration yet, search configuration in Thunderbird&#39;s centeral database */</span></div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        <span class="keywordflow">if</span>( param_autoconfig==NULL )</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;        {</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;            <span class="keywordtype">char</span>* url = mr_mprintf(<span class="stringliteral">&quot;https://autoconfig.thunderbird.net/v1.1/%s&quot;</span>, param_domain); <span class="comment">/* always SSL for Thunderbird&#39;s database */</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;            param_autoconfig = moz_autoconfigure(mailbox, url, param);</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;            free(url);</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;            PROGRESS(50)</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;        }</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;        <span class="comment">/* C.  Do we have any result? */</span></div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;        <span class="keywordflow">if</span>( param_autoconfig )</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        {</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;            { <span class="keywordtype">char</span>* r = mrloginparam_get_readable(param_autoconfig); mrmailbox_log_info(mailbox, 0, <span class="stringliteral">&quot;Got autoconfig: %s&quot;</span>, r); free(r); }</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;            <span class="keywordflow">if</span>( param_autoconfig-&gt;m_mail_user ) {</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                free(param-&gt;m_mail_user);</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                param-&gt;m_mail_user= strdup_keep_null(param_autoconfig-&gt;m_mail_user);</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;            }</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;            param-&gt;m_mail_server  = strdup_keep_null(param_autoconfig-&gt;m_mail_server); <span class="comment">/* all other values are always NULL when entering autoconfig */</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;            param-&gt;m_mail_port    =                  param_autoconfig-&gt;m_mail_port;</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;            param-&gt;m_send_server  = strdup_keep_null(param_autoconfig-&gt;m_send_server);</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;            param-&gt;m_send_port    =                  param_autoconfig-&gt;m_send_port;</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;            param-&gt;m_send_user    = strdup_keep_null(param_autoconfig-&gt;m_send_user);</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;            param-&gt;m_server_flags =                  param_autoconfig-&gt;m_server_flags;</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;            <span class="comment">/* althoug param_autoconfig&#39;s data are no longer needed from, it is important to keep the object as</span></div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="comment">            we may enter &quot;deep guessing&quot; if we could not read a configuration */</span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        }</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    }</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="comment">/* 3.  Internal specials (eg. for uploading to chats-folder etc.)</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;<span class="comment">     **************************************************************************/</span></div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    <span class="keywordflow">if</span>( strcasecmp(param_domain, <span class="stringliteral">&quot;gmail.com&quot;</span>)==0 || strcasecmp(param_domain, <span class="stringliteral">&quot;googlemail.com&quot;</span>)==0 )</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    {</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        <span class="comment">/* NB: Checking GMa&#39;l too often (&lt;10 Minutes) may result in blocking, says https://github.com/itprojects/InboxPager/blob/HEAD/README.md#gmail-configuration</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="comment">        Also note https://www.google.com/settings/security/lesssecureapps */</span></div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;        param-&gt;m_server_flags |= MR_AUTH_XOAUTH2 | MR_NO_EXTRA_IMAP_UPLOAD | MR_NO_MOVE_TO_CHATS;</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    }</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="comment">/* 2.  Fill missing fields with defaults</span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="comment">     **************************************************************************/</span></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="preprocessor">    #define TYPICAL_IMAP_SSL_PORT       993 </span><span class="comment">/* our default */</span><span class="preprocessor"></span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="preprocessor">    #define TYPICAL_IMAP_STARTTLS_PORT  143 </span><span class="comment">/* not used very often but eg. by posteo.de, default for PLAIN */</span><span class="preprocessor"></span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="preprocessor">    #define TYPICAL_SMTP_SSL_PORT       465 </span><span class="comment">/* our default */</span><span class="preprocessor"></span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;<span class="preprocessor">    #define TYPICAL_SMTP_STARTTLS_PORT  587 </span><span class="comment">/* also used very often, SSL:STARTTLS is maybe 50:50 */</span><span class="preprocessor"></span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="preprocessor">    #define TYPICAL_SMTP_PLAIN_PORT      25</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    <span class="keywordflow">if</span>( param-&gt;m_mail_server == NULL ) {</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;        param-&gt;m_mail_server = mr_mprintf(<span class="stringliteral">&quot;imap.%s&quot;</span>, param_domain);</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    }</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    <span class="keywordflow">if</span>( param-&gt;m_mail_port == 0 ) {</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        param-&gt;m_mail_port = (param-&gt;m_server_flags&amp;(MR_IMAP_SOCKET_STARTTLS|MR_IMAP_SOCKET_PLAIN))?  TYPICAL_IMAP_STARTTLS_PORT : TYPICAL_IMAP_SSL_PORT;</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    }</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    <span class="keywordflow">if</span>( param-&gt;m_mail_user == NULL ) {</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;        param-&gt;m_mail_user = safe_strdup(param-&gt;m_addr);</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    }</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <span class="keywordflow">if</span>( param-&gt;m_send_server == NULL &amp;&amp; param-&gt;m_mail_server ) {</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        param-&gt;m_send_server = safe_strdup(param-&gt;m_mail_server);</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;        <span class="keywordflow">if</span>( strncmp(param-&gt;m_send_server, <span class="stringliteral">&quot;imap.&quot;</span>, 5)==0 ) {</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;            memcpy(param-&gt;m_send_server, <span class="stringliteral">&quot;smtp&quot;</span>, 4);</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;        }</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    }</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;    <span class="keywordflow">if</span>( param-&gt;m_send_port == 0 ) {</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        param-&gt;m_send_port = (param-&gt;m_server_flags&amp;MR_SMTP_SOCKET_STARTTLS)?  TYPICAL_SMTP_STARTTLS_PORT :</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;            ((param-&gt;m_server_flags&amp;MR_SMTP_SOCKET_PLAIN)? TYPICAL_SMTP_PLAIN_PORT : TYPICAL_SMTP_SSL_PORT);</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    }</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    <span class="keywordflow">if</span>( param-&gt;m_send_user == NULL &amp;&amp; param-&gt;m_mail_user ) {</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        param-&gt;m_send_user = safe_strdup(param-&gt;m_mail_user);</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    }</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    <span class="keywordflow">if</span>( param-&gt;m_send_pw == NULL &amp;&amp; param-&gt;m_mail_pw ) {</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        param-&gt;m_send_pw = safe_strdup(param-&gt;m_mail_pw);</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    }</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    <span class="keywordflow">if</span>( !mr_exactly_one_bit_set(param-&gt;m_server_flags&amp;MR_AUTH_FLAGS) )</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    {</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        param-&gt;m_server_flags &amp;= ~MR_AUTH_FLAGS;</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        param-&gt;m_server_flags |= MR_AUTH_NORMAL;</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    }</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    <span class="keywordflow">if</span>( !mr_exactly_one_bit_set(param-&gt;m_server_flags&amp;MR_IMAP_SOCKET_FLAGS) )</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    {</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        param-&gt;m_server_flags &amp;= ~MR_IMAP_SOCKET_FLAGS;</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        param-&gt;m_server_flags |= (param-&gt;m_send_port==TYPICAL_IMAP_STARTTLS_PORT?  MR_IMAP_SOCKET_STARTTLS : MR_IMAP_SOCKET_SSL);</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    }</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    <span class="keywordflow">if</span>( !mr_exactly_one_bit_set(param-&gt;m_server_flags&amp;MR_SMTP_SOCKET_FLAGS) )</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    {</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        param-&gt;m_server_flags &amp;= ~MR_SMTP_SOCKET_FLAGS;</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;        param-&gt;m_server_flags |= ( param-&gt;m_send_port==TYPICAL_SMTP_STARTTLS_PORT?  MR_SMTP_SOCKET_STARTTLS :</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;            (param-&gt;m_send_port==TYPICAL_SMTP_PLAIN_PORT? MR_SMTP_SOCKET_PLAIN: MR_SMTP_SOCKET_SSL) );</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;    }</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    <span class="comment">/* do we have a complete configuration? */</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    <span class="keywordflow">if</span>( param-&gt;m_addr         == NULL</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;     || param-&gt;m_mail_server  == NULL</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;     || param-&gt;m_mail_port    == 0</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;     || param-&gt;m_mail_user    == NULL</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;     || param-&gt;m_mail_pw      == NULL</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;     || param-&gt;m_send_server  == NULL</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;     || param-&gt;m_send_port    == 0</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;     || param-&gt;m_send_user    == NULL</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;     || param-&gt;m_send_pw      == NULL</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;     || param-&gt;m_server_flags == 0 )</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    {</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        mrmailbox_log_error(mailbox, 0, <span class="stringliteral">&quot;Account settings incomplete.&quot;</span>);</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;        <span class="keywordflow">goto</span> exit_;</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    }</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;    PROGRESS(60)</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    <span class="comment">/* try to connect to IMAP */</span></div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    { <span class="keywordtype">char</span>* r = mrloginparam_get_readable(param); mrmailbox_log_info(mailbox, 0, <span class="stringliteral">&quot;Trying: %s&quot;</span>, r); free(r); }</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;    <span class="keywordflow">if</span>( !mrimap_connect(mailbox-&gt;m_imap, param) ) {</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;        <span class="keywordflow">goto</span> exit_;</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    }</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    imap_connected = 1;</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    PROGRESS(80)</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    <span class="comment">/* try to connect to SMTP - if we did not got an autoconfig, the first try was SSL-465 and we do a second try with STARTTLS-587 */</span></div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;    if( !mrsmtp_connect(mailbox-&gt;m_smtp, param) )  {</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;        <span class="keywordflow">if</span>( param_autoconfig ) {</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;            <span class="keywordflow">goto</span> exit_;</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        }</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;        PROGRESS(85)</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        param-&gt;m_server_flags &amp;= ~MR_SMTP_SOCKET_FLAGS;</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;        param-&gt;m_server_flags |=  MR_SMTP_SOCKET_STARTTLS;</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;        param-&gt;m_send_port    =   TYPICAL_SMTP_STARTTLS_PORT;</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        { <span class="keywordtype">char</span>* r = mrloginparam_get_readable(param); mrmailbox_log_info(mailbox, 0, <span class="stringliteral">&quot;Trying: %s&quot;</span>, r); free(r); }</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        <span class="keywordflow">if</span>( !mrsmtp_connect(mailbox-&gt;m_smtp, param) ) {</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;            <span class="keywordflow">goto</span> exit_;</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        }</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    }</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    PROGRESS(90)</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;    <span class="comment">/* configuration success - write back the configured parameters with the &quot;configured_&quot; prefix; also write the &quot;configured&quot;-flag */</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    mrsqlite3_lock(mailbox-&gt;m_sql);</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    locked = 1;</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        mrloginparam_write__(param, mailbox-&gt;m_sql, &quot;configured_&quot; <span class="comment">/*the trailing underscore is correct*/</span>);</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        mrsqlite3_set_config_int__(mailbox-&gt;m_sql, &quot;configured&quot;, 1);</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    mrsqlite3_unlock(mailbox-&gt;m_sql);</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    locked = 0;</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    success = 1;</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    mrmailbox_log_info(mailbox, 0, &quot;Configure completed successfully.&quot;);</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;exit_:</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    if( locked ) { mrsqlite3_unlock(mailbox-&gt;m_sql); }</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    <span class="keywordflow">if</span>( !success &amp;&amp; imap_connected ) {</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        mrimap_disconnect(mailbox-&gt;m_imap);</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    }</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    mrloginparam_unref(param);</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;    mrloginparam_unref(param_autoconfig);</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    free(param_addr_urlencoded);</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;    s_configure_do_exit = 1; <span class="comment">/* set this before sending MR_EVENT_CONFIGURE_ENDED, avoids mrmailbox_configure_cancel() to stop the thread */</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    mailbox-&gt;m_cb(mailbox, MR_EVENT_CONFIGURE_ENDED, success, 0);</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    s_configure_thread_created = 0;</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    mrosnative_unsetup_thread(mailbox); <span class="comment">/* must be very last */</span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;}</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;<span class="comment">/*******************************************************************************</span></div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;<span class="comment"> * Main interface</span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;<span class="comment"> ******************************************************************************/</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;</div><div class="line"><a name="l00665"></a><span class="lineno"><a class="line" href="structmrmailbox__t.html#af204aadf66e8adf5403987c5dcf85387">  665</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="structmrmailbox__t.html#af204aadf66e8adf5403987c5dcf85387">mrmailbox_configure_and_connect</a>(<a class="code" href="structmrmailbox__t.html">mrmailbox_t</a>* mailbox)</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;{</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;    <span class="keywordflow">if</span>( mailbox == NULL ) {</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;    }</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    <span class="keywordflow">if</span>( !mrsqlite3_is_open(mailbox-&gt;m_sql) ) {</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;        mrmailbox_log_error(mailbox, 0, <span class="stringliteral">&quot;Cannot configure, database not opened.&quot;</span>);</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;        s_configure_do_exit = 1;</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;        mailbox-&gt;m_cb(mailbox, MR_EVENT_CONFIGURE_ENDED, 0, 0);</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    }</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    <span class="keywordflow">if</span>( s_configure_thread_created || s_configure_do_exit == 0 ) {</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;        mrmailbox_log_error(mailbox, 0, <span class="stringliteral">&quot;Already configuring.&quot;</span>);</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;        <span class="keywordflow">return</span>; <span class="comment">/* do not send a MR_EVENT_CONFIGURE_ENDED event, this is done by the already existing thread */</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    }</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    s_configure_thread_created = 1;</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    s_configure_do_exit        = 0;</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    <span class="comment">/* disconnect */</span></div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    mrmailbox_disconnect(mailbox);</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    mrsqlite3_lock(mailbox-&gt;m_sql);</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;        <span class="comment">//mrsqlite3_set_config_int__(mailbox-&gt;m_sql, &quot;configured&quot;, 0); -- NO: we do _not_ reset this flag if it was set once; otherwise the user won&#39;t get back to his chats (as an alternative, we could change the UI).  Moreover, and not changeable in the UI, we use this flag to check if we shall search for backups.</span></div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;        mailbox-&gt;m_smtp-&gt;m_log_connect_errors = 1;</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;        mailbox-&gt;m_imap-&gt;m_log_connect_errors = 1;</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        mrjob_kill_action__(mailbox, MRJ_CONNECT_TO_IMAP);</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    mrsqlite3_unlock(mailbox-&gt;m_sql);</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    <span class="comment">/* start a thread for the configuration it self, when done, we&#39;ll post a MR_EVENT_CONFIGURE_ENDED event */</span></div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    pthread_create(&amp;s_configure_thread, NULL, configure_thread_entry_point, mailbox);</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;}</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;</div><div class="line"><a name="l00709"></a><span class="lineno"><a class="line" href="structmrmailbox__t.html#a8127c0e3f4cfda14fdfd7be9f43715ef">  709</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="structmrmailbox__t.html#a8127c0e3f4cfda14fdfd7be9f43715ef">mrmailbox_configure_cancel</a>(<a class="code" href="structmrmailbox__t.html">mrmailbox_t</a>* mailbox)</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;{</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;    <span class="keywordflow">if</span>( mailbox == NULL ) {</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    }</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    <span class="keywordflow">if</span>( s_configure_thread_created &amp;&amp; s_configure_do_exit==0 )</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    {</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        mrmailbox_log_info(mailbox, 0, <span class="stringliteral">&quot;Stopping configure-thread...&quot;</span>);</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;            s_configure_do_exit = 1;</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;            pthread_join(s_configure_thread, NULL);</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        mrmailbox_log_info(mailbox, 0, <span class="stringliteral">&quot;Configure-thread stopped.&quot;</span>);</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    }</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;}</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;</div><div class="line"><a name="l00735"></a><span class="lineno"><a class="line" href="structmrmailbox__t.html#aa6e325e49ecccfc96276db6c327dba94">  735</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="structmrmailbox__t.html#aa6e325e49ecccfc96276db6c327dba94">mrmailbox_is_configured</a>(<a class="code" href="structmrmailbox__t.html">mrmailbox_t</a>* mailbox)</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;{</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;    <span class="keywordtype">int</span> is_configured;</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    <span class="keywordflow">if</span>( mailbox == NULL ) {</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    }</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;    <span class="keywordflow">if</span>( mrimap_is_connected(mailbox-&gt;m_imap) ) { <span class="comment">/* if we&#39;re connected, we&#39;re also configured. this check will speed up the check as no database is involved */</span></div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    }</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    mrsqlite3_lock(mailbox-&gt;m_sql);</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;        is_configured = mrsqlite3_get_config_int__(mailbox-&gt;m_sql, <span class="stringliteral">&quot;configured&quot;</span>, 0);</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    mrsqlite3_unlock(mailbox-&gt;m_sql);</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;    <span class="keywordflow">return</span> is_configured? 1 : 0;</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;}</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;</div><div class="ttc" id="structmrmailbox__t_html"><div class="ttname"><a href="structmrmailbox__t.html">mrmailbox_t</a></div><div class="ttdoc">An object representing a single mailbox. </div><div class="ttdef"><b>Definition:</b> <a href="mrmailbox_8h_source.html#l00141">mrmailbox.h:141</a></div></div>
<div class="ttc" id="structmrmailbox__t_html_af204aadf66e8adf5403987c5dcf85387"><div class="ttname"><a href="structmrmailbox__t.html#af204aadf66e8adf5403987c5dcf85387">mrmailbox_t::mrmailbox_configure_and_connect</a></div><div class="ttdeci">void mrmailbox_configure_and_connect(mrmailbox_t *mailbox)</div><div class="ttdoc">Configure and connect a mailbox. </div><div class="ttdef"><b>Definition:</b> <a href="mrmailbox__configure_8c_source.html#l00665">mrmailbox_configure.c:665</a></div></div>
<div class="ttc" id="structmrmailbox__t_html_aa6e325e49ecccfc96276db6c327dba94"><div class="ttname"><a href="structmrmailbox__t.html#aa6e325e49ecccfc96276db6c327dba94">mrmailbox_t::mrmailbox_is_configured</a></div><div class="ttdeci">int mrmailbox_is_configured(mrmailbox_t *mailbox)</div><div class="ttdoc">Check if the mailbox is already configured. </div><div class="ttdef"><b>Definition:</b> <a href="mrmailbox__configure_8c_source.html#l00735">mrmailbox_configure.c:735</a></div></div>
<div class="ttc" id="structmrmailbox__t_html_a8127c0e3f4cfda14fdfd7be9f43715ef"><div class="ttname"><a href="structmrmailbox__t.html#a8127c0e3f4cfda14fdfd7be9f43715ef">mrmailbox_t::mrmailbox_configure_cancel</a></div><div class="ttdeci">void mrmailbox_configure_cancel(mrmailbox_t *mailbox)</div><div class="ttdoc">Cancel an configuration started by mrmailbox_configure_and_connect(). </div><div class="ttdef"><b>Definition:</b> <a href="mrmailbox__configure_8c_source.html#l00709">mrmailbox_configure.c:709</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Nov 14 2017 02:47:14 for Delta Chat Core C-Library by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
